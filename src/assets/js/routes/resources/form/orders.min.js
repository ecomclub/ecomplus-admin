!function(){"use strict";var h=window.lang,_=window.i18n,y=window.tabId,e=window.Tabs[y],p=e.commit,w=function(){return e.data},t=function(){var g=w();console.log(g);var t,f,e=window.location.href.split("/"),n=e[e.length-1],b=$("#t"+y+"-order-base"),a=b.find("#t"+y+"-order-amount"),i=a.find('input[name="amount.total"]');a.find('input:not([name="amount.total"])').change(function(){setTimeout(function(){var e=w().amount,t=(e.subtotal||0)+(e.freight||0)-(e.discount||0);e.tax&&(t+=e.tax),e.extra&&(t+=e.extra),i.val(formatMoney(0<=t?t:0)).trigger("change")},150)}),setTimeout(function(){if(t=b.find("#t"+y+"-order-buyers"),f=t.find("#t"+y+"-buyer-info"),g.buyers)for(var e=0;e<g.buyers.length;e++)o(g.buyers[e])},200);var o=function(e){var t,a=e._id,n="",i=e.main_email;if(i&&(n+='<a href="mailto:'+i+'" target="_blank">'+i+"</a>"),e.name?(t=e.name.given_name,e.name.middle_name&&(t+=" "+e.name.middle_name),e.name.family_name&&(t+=" "+e.name.family_name),e.display_name&&(t+=" ("+e.display_name+")")):e.display_name&&(t=e.display_name),t&&(n+="<br>"+t),e.phones){e.phones.length&&(n+="<br>");for(var s=0;s<e.phones.length;s++){0<s&&(n+=" / ");var o=formatPhone(e.phones[s]);n+='<a class="text-muted" href="tel:'+o.replace(/\D/g,"")+'" target="_blank">'+o+"</a>"}}var r=e.doc_number;r&&(n+="<br>"+r);var d=$("<a>",{href:"#/resources/customers/"+a,html:'<i class="fa fa-pencil"></i> '+_({en_us:"edit registration",pt_br:"editar cadastro"})}),l=$("<i>",{class:"p-10 remove fa fa-trash"}).click(function(){for(var e=w(),t=e.buyers,n=0;n<t.length;n++){if(t[n]._id===a){t.splice(n,1),p(e,!0);break}}c.slideUp(300,function(){$(this).remove()})}),c=$("<div>",{class:"hidden mb-3 nested-block",html:[l,"<div>"+n+"</div>",d]});f.append(c),c.slideDown()},r=b.find("#t"+y+"-new-buyer"),s=r.find("input"),d=[],l=function(){r.addClass("ajax");var e="customers.json?main_email="+encodeURIComponent(s.val().trim());e+="&fields=_id,main_email,doc_number,name,display_name,phones,addresses",window.callApi(e,"GET",function(e,t){if(r.removeClass("ajax"),!e){var n=t.result[0];if(n){var a=w();a.buyers||(a.buyers=[]);for(var i=a.buyers,s=0;s<i.length;s++)if(i[s]._id===n._id)return void app.toast(_({en_us:"This customer has already been added",pt_br:"Este cliente jÃ¡ foi adicionado"}));!d.length&&n.addresses&&(d=n.addresses),delete n.addresses,i.push(n),p(a,!0),o(n)}else app.toast(_({en_us:"No customers found with this email",pt_br:"Nenhum cliente encontrado com este e-mail"}))}})};if(s.click(function(){$(this).select()}).keydown(function(e){switch(e.which){case 13:e.preventDefault(),l()}}),r.find("button").click(l),b.find("#t"+y+"-add-buyer").click(function(){r.slideToggle().find("input"),s.val("").focus()}),b.find("#t"+y+"-open-invoice").click(function(){window.location.href="/#/invoices/"+n}),b.find("#t"+y+"-open-ticket").click(function(){window.location.href="/#/tag/"+n}),g.buyers&&g.buyers.length){var c="customers/"+g.buyers[0]._id+".json";window.callApi(c,"GET",function(e,t){e||(d=t.addresses||[])},null,!0)}$.getJSON("json/misc/config_lists.json",function(e){for(var a,t="financial_status/current",n="fulfillment_status/current",i=["status",t,n],s=0;s<i.length;s++){var o=i[s],r=o.replace("/","."),d=[];for(var l in a=e.orders[o].enum)a.hasOwnProperty(l)&&d.push($("<option>",{value:l,text:l,"data-content":'<span class="text-'+a[l].class+'">'+_(a[l].text)+"</span>"}));"status"!==o&&d.unshift('<option value="" selected > -- </option>');var c=b.find('select[name="'+r+'"]');c.html(d);var f=getFromDotNotation(w(),r);f&&c.val(f),c.selectpicker("refresh")}var m=$("#t"+y+"-order-timeline"),u=[],h={payments_history:t,fulfillments:n};for(var p in h)h.hasOwnProperty(p)&&g[p]&&(a=e.orders[h[p]].enum,g[p].forEach(function(e){var t;for(var n in a)if(a.hasOwnProperty(n)&&n===e.status){t=a[n];break}t.date_time=e.date_time,t.type=p,u.push(t)}));if(u.length){u.sort(function(e,t){return e.date_time>t.date_time?1:e.date_time<t.date_time?-1:0});var v=["day","month","year","hour","minute","second"];u.forEach(function(e){var t=e.class||"default",n="";e.date_time&&(n+='<time datetime="'+e.date_time+'">'+formatDate(e.date_time,v)+"</time>"),n+="<p>"+_(e.text)+"</p>",m.append($("<li>",{class:"timeline-block",html:[$("<div>",{class:"timeline-point",html:'<span class="badge badge-dot badge-lg badge-'+t+'"></span>'}),$("<div>",{class:"timeline-content",html:n})]}))}),m.closest(".hidden").slideDown()}});var m=$("#t"+y+"-order-payment");handleNestedObjects(w,p,m,$("#t"+y+"-add-transaction"),$("#t"+y+"-delete-transaction"),$("#t"+y+"-next-transaction"),"transactions"),m.find("#t"+y+"-payment-method-code").change(function(){var e=$(this).find("[selected]").data("content");if(e){var t=$(this).data("object-id"),n=$(e).children('[data-lang="'+h+'"]').text();if(n)for(var a=w(),i=0;i<a.transactions.length;i++){var s=a.transactions[i];if(s._id===t){s.payment_method.name=n,p(a,!0);break}}}});var u=$("#t"+y+"-order-shipping");handleNestedObjects(w,p,u,$("#t"+y+"-add-shipping"),$("#t"+y+"-delete-shipping"),$("#t"+y+"-next-shipping"),"shipping_lines",function(e){var t;if(e.from={zip:"00000000"},d.length){for(var n=0;n<d.length;n++)if(d[n].default){t=d[n];break}t||(t=d[0])}e.to=Object.assign({zip:"00000000"},t),delete e.to.default,delete e.to._id}),$("div[data-link-collapse]").each(function(){var e=$(this),n=e.children("div"),a=e.children("em"),t=function(){var t="";n.find("input").each(function(){var e=$(this).val();("string"==typeof e&&""!==e.trim()||"number"==typeof e)&&(t+=e+", ")}),a.text(t.slice(0,-2))};e.children("a").click(function(){n.slideToggle("slow"),t(),a.slideToggle()}),t()})};e.$form?t():$(document).one("form-"+y,t)}();